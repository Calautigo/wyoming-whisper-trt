# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

# GitHub recommends pinning actions to a commit SHA.
# To get a newer version, you will need to update the SHA.
# You can also reference a tag or branch, but the action may change without warning.

name: Publish Docker Images
permissions:
  contents: read
  pull-requests: write

on:
  release:
    types: [published]

jobs:
   build_and_push_images:
    name: Build and Push Docker Images
    runs-on: self-hosted
    permissions:
      packages: write
      contents: read
      attestations: write
      id-token: write
    steps:
      - name: Check out the repo
        uses: actions/checkout@85e6279cec87321a52edac9c87bce653a07cf6c2

      - name: Install Nvidia Drivers
        shell: bash
        run: |
          wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2404/x86_64/cuda-keyring_1.1-1_all.deb
          sudo dpkg -i cuda-keyring_1.1-1_all.deb
          sudo apt-get update
          sudo apt-get install -y nvidia-open
      
      - name: Install CUDA Toolkit
        uses: Jimver/cuda-toolkit@8022558310ea543e35132143092835585f60e628

      - name: Install Docker and Buildx
        shell: bash
        run: |
          # Add Docker's official GPG key:
          sudo apt-get update
          sudo apt-get install ca-certificates curl
          sudo install -m 0755 -d /etc/apt/keyrings
          sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
          sudo chmod a+r /etc/apt/keyrings/docker.asc

          # Add the repository to Apt sources:
          echo \
            "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
            $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
          sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
          sudo apt-get update
          sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

      - name: Set up QEMU
        uses: docker/setup-qemu-action@f30d974279f970cd3ed4ee3bcf1ff7795e271f00
        with:
          platforms: all

      - name: Install Nvidia Container Toolkit
        shell: bash
        run: |
          curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey | sudo gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg \
          && curl -s -L https://nvidia.github.io/libnvidia-container/stable/deb/nvidia-container-toolkit.list | \
            sed 's#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g' | \
            sudo tee /etc/apt/sources.list.d/nvidia-container-toolkit.list
          sudo apt-get update
          sudo apt-get install -y nvidia-container-toolkit
          sudo nvidia-ctk runtime configure --runtime=docker
          sudo systemctl restart docker

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@ba31df4664624f17e1b1ef1c9c85ed1ca9463a6d

      - name: Log in to Docker Hub
        uses: docker/login-action@327cd5a69de6c009b9ce71bce8395f28e651bf99
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@8e1d5461f02b7886d3c1a774bfbd873650445aa2
        with:
          images: captnspdr/wyoming-whisper-trt

      - name: Build and Push AMD64 dGPU Image
        id: push-amd64
        uses: docker/build-push-action@ca877d9245402d1537745e0e356eab47c3520991
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}-amd64
          labels: ${{ steps.meta.outputs.labels }}-amd64
          platforms: linux/amd64

      - name: Build and Push ARM64 dGPU Image
        id: push-arm64
        uses: docker/build-push-action@ca877d9245402d1537745e0e356eab47c3520991
        with:
          context: .
          file: ./Dockerfile.arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}-arm64
          labels: ${{ steps.meta.outputs.labels }}-arm64
          platforms: linux/arm64

      - name: Build and Push ARM64 iGPU Image
        id: push-arm64-igpu
        uses: docker/build-push-action@ca877d9245402d1537745e0e356eab47c3520991
        with:
          context: .
          file: ./Dockerfile.igpu
          push: true
          tags: ${{ steps.meta.outputs.tags }}-igpu
          labels: ${{ steps.meta.outputs.labels }}-igpu
          platforms: linux/arm64

      - name: Create and Push Multi-Arch Manifest (dGPU)
        if: always()
        run: |
          echo "Creating multi-arch manifest for dGPU images..."
          TAGS="${{ steps.meta.outputs.tags }}"
          echo "TAGS are: $TAGS"

          # The TAGS variable might look like:
          #   "captnspdr/wyoming-whisper-trt:1.0.3 captnspdr/wyoming-whisper-trt:latest"
          # We need to loop over them individually:
          for TAG in $TAGS; do
            echo "Creating multi-arch manifest for $TAG"
            docker manifest create "$TAG" \
              --amend "$TAG-amd64" \
              --amend "$TAG-arm64"

            echo "Pushing multi-arch manifest for $TAG"
            docker manifest push "$TAG"
          done
